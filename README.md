# traffic-camera-raspberry-pi

## Introduction
<p>Want to track the license plates of speeding cars with a traffic camera that is 40 times cheaper than that of a commercial one? This Instructable shows how you can use the <strong>Raspberry Pi</strong>, <strong>Camera Module v2</strong>, 8x8 LED Matrix,<strong> </strong>and <strong>OPS243 Radar Sensor </strong>to obtain the license plates of vehicles speeding up to 60 mph!</p><p>What you'll gain from this project includes the following:</p><ul><li>Intermediate Python programming techniques (e.g., os and multiprocessing libraries, and modular programming)<li>Basics of Linux Shell Commands (e.g., nano)<li>Basics of 3D Printing<li>Intermediate Electronics/Hardware Setup (e.g., LED Matrix, OPS243)</ul>

## Supplies
<h3>Single-Board Computer and its Peripherals</h3><ol><li>Raspberry Pi 3/3 Model B+/4 Model B and Power Supply/Adapter</li><li>OPS243 Radar Doppler Sensor (-A or -C)</li><li>Raspberry Pi Camera Module (v1 or v2)</li><li>Battery Pack of at least 20,000 mAh and 2 A Output</li><li>(Recommended) 8x8 LED Matrix</li><li>(Recommended) Raspberry Pi Cooling Fan</li><li>(Recommended) PC Laptop for rapid testing</li><li>(Recommended) Display Monitor, Keyboard, and Mouse, or "Headless Mode" via SSH or Remote Desktop</li></ol><h3>Wiring</h3><ol><li>USB Female to USB-C</li><li>USB 2.0 A-Male to Micro B</li><li>(5) Five Male-to-Male Dupont Wires</li><li>(Recommended) Ethernet Cable</li></ol><h3>Camera Enclosure</h3><ol><li>3D Printer of Bed Size 235 x 235 mm, and 200g of PLA Filament or Online Purchased Raspberry Pi Enclosure</li><li>Camera Tripod</li><li>(1) One 1/4-20 Hex Nut</li></ol><h3>Miscellaneous</h3><ol><li>Flat head screwdriver</li><li>Soldering Iron or Hot Glue Gun</li><li>(Recommended) Duct tape</li></ol><h3><br></h3><p>The supplies in typefaced in bold are the ones used for this Instructable.</p>

## Step 1: Download Python Project
<p><strong>Download Python Project &quot;traffic_camera_project&quot; attached below. </strong>The downloaded folder has a simple project structure.</p><p class="ql-indent-1">traffic_camera_project</p><p class="ql-indent-1">|---- README.txt</p><p class="ql-indent-1">|---- traffic_camera</p><p>           |---- |---- __init__.py</p><p class="ql-indent-1">|---- |---- camera_config.py</p><p class="ql-indent-1">|---- |---- file_org.py</p><p class="ql-indent-1">|---- |---- serial_interface.py</p><p class="ql-indent-1">|---- |---- led_dot_matrix.py</p><p class="ql-indent-1">|---- |---- license_plate_recognition_API.py</p><p class="ql-indent-1">|---- |---- _testUSB.py</p><p class="ql-indent-1">|---- |---- _test_picamera.py</p><p class="ql-indent-1">|---- main.py</p><p class="ql-indent-1"><br></p><p><strong>main.py</strong>. This is the main program that is run for the traffic speed camera. It imports all the five modules in the package traffic_camera: camera_config.py, file_org.py, serial_interface.py, led_dot_matrix.py, and license_plate_recognition_API.py.</p><p><strong>README.txt</strong>. This is a text file that reads the details of the project.</p><p><strong>camera_config.py. </strong>This module creates a PiCamera.picamera object, sets its initial configurations, and runs a background process for continuous camera capture.</p><p><strong>file_org.py</strong>. This module involves all functions related to creating/removing folders and moving files around to different folders.</p><p><strong>serial_interface.py.</strong> This module involves all functions related to reading and writing data from the USB interface established between the OPS243 Radar Doppler Sensor and the Raspberry Pi. Requires a third-party library installation (shown in Step 2).</p><p><strong>led_dot_matrix.py. </strong>This module involves all functions and objects related to the 8x8 LED Dot Matrix. Requires a third-party library installation (shown in Step 2).</p><p><strong>license_plate_recognition_API.py. </strong>This module runs a background process for sending speeding vehicle photos to the License Plate Recognizer API.</p><p><strong>_testUSB.py and _test_picamera.py</strong>. These modules assist in unit testing the traffic camera, such as ensuring that data is being read from the OPS243 and that the Raspberry Camera Module is working properly and taking photos towards the desired direction.</p>

## Step 2: Download Third-Party Python Libraries
<p>On Raspberry Pi terminal, run the following Linux Shell Commands to install the third-party Python libraries used for this project:</p><p><a href="https://pyserial.readthedocs.io/en/latest/pyserial.html " rel="nofollow"><strong>Pyserial</strong></a><strong>: </strong>Allows to read and write data to serial interfaced peripherals</p><pre class="ql-syntax" spellcheck="false">$ python -m pip install pyserial
</pre><p><br></p><p><a href="https://max7219.readthedocs.io/en/0.2.3/" rel="nofollow"><strong>MAX7219</strong></a>: Allows to program 8x8 LED Matrix with Python</p><pre class="ql-syntax" spellcheck="false">$ sudo apt-get install python-dev python-pip
$ sudo pip install max7219
</pre>

## Step 3: COnfigure Settings on Raspberry Pi
<p><strong>Update Raspberry Pi. </strong>Run the following command on the Raspberry Pi terminal:</p><pre class="ql-syntax" spellcheck="false">$ sudo apt update
</pre><p><br></p><p><strong>Enable Camera and SSH on Raspberry Pi Configuration. </strong>Run the following command on the Raspberry Pi terminal:</p><pre class="ql-syntax" spellcheck="false">$ sudo raspi-config
</pre><p>Under the Interfaces tab, Enable Camera and SSH. You may need to restart the Raspberry Pi for these changes to take effect.</p><p><br></p><p><strong>Edit /etc/profile script so that project runs upon startup. </strong>Run the following command on the Raspberry Pi terminal:</p><pre class="ql-syntax" spellcheck="false">$ sudo nano /etc/profile
</pre><p>Scroll to the bottom and add the following line:</p><pre class="ql-syntax" spellcheck="false">$ sudo python /home/pi/traffic_camera_project/main.py
</pre><p>Exit the script by pressing <strong>Ctrl+X, Y</strong>, and <strong>Enter. </strong>Now, the board will run the python script as soon as it is finishing powering up. More information on configuring Python scripts upon startup can be seen <a href="https://www.raspberrypi-spy.co.uk/2015/02/how-to-autorun-a-python-script-on-raspberry-pi-boot/" rel="noopener noreferrer" target="_blank">here</a>.</p>

## Step 4: Create Account on License Plate Recognizer
<p><strong>Update Raspberry Pi. </strong>Run the following command on the Raspberry Pi terminal:</p><pre class="ql-syntax" spellcheck="false">$ sudo apt update
</pre><p><br></p><p><strong>Enable Camera and SSH on Raspberry Pi Configuration. </strong>Run the following command on the Raspberry Pi terminal:</p><pre class="ql-syntax" spellcheck="false">$ sudo raspi-config
</pre><p>Under the Interfaces tab, Enable Camera and SSH. You may need to restart the Raspberry Pi for these changes to take effect.</p><p><br></p><p><strong>Edit /etc/profile script so that project runs upon startup. </strong>Run the following command on the Raspberry Pi terminal:</p><pre class="ql-syntax" spellcheck="false">$ sudo nano /etc/profile
</pre><p>Scroll to the bottom and add the following line:</p><pre class="ql-syntax" spellcheck="false">$ sudo python /home/pi/traffic_camera_project/main.py
</pre><p>Exit the script by pressing <strong>Ctrl+X, Y</strong>, and <strong>Enter. </strong>Now, the board will run the python script as soon as it is finishing powering up. More information on configuring Python scripts upon startup can be seen <a href="https://www.raspberrypi-spy.co.uk/2015/02/how-to-autorun-a-python-script-on-raspberry-pi-boot/" rel="noopener noreferrer" target="_blank">here</a>.</p>

## Step 5: Modify User Arguments On Main.Py
<p><strong>Access main.py from traffic_camera_project</strong>. From Step 1, the entire Python code should already be downloaded onto the Raspberry Pi. Open the Python script <strong>main.py</strong>.</p><p><strong>Modify User Arguments</strong>. On lines 37 to 40, there are four user arguments that can be modified to the user's application of the project, such as the speed at which the traffic camera will begin taking pictures and where these photos will be stored. Change the values of these four variables to your application.</p><pre class="ql-syntax" spellcheck="false">speed_limit = 10 # in mph
main_folder = &quot;LPR Speed Photos&quot; # Name of your main directory
parent_directory = '/home/pi/Desktop/' # Location of your main directory
token = YOUR_UNIQUE_TOKEN_FROM_STEP_4
</pre><p>The speed_limit is an integer variable that reflects the speed limit of the street the traffic camera is monitoring. </p><p>The main_folder is the name of the main directory for which photos will be stored on the Raspberry Pi. </p><p>The parent_directory is a string variable of the path of main_folder. </p><p>The token is a string variable of the token value obtained from Step 4.</p><p>**Note: In a future revision, the argparse Python library will be implemented to the main.py script so that the user can input these arguments from the command line instead of having to open an editor to modify these four variables.**</p>

## Step 6: Configure OPS243 Doppler Radar Sensor
<p><strong>Connect OPS243 Doppler Radar Sensor to Raspberry Pi. </strong>With the USB 2.0 A-Male to Micro B cable, plug in the sensor to any port on the Raspberry Pi. The OPS243 can communicate with other interfaces, such as UART and Wifi, but in this particular project, data will be communicated via serial interface.</p><p><strong>Access Report Data from Radar Sensor from PuTTY. </strong>PuTTY is a free SSH client that enables the report data from the OPS243 to be conveniently read. If not already on the Pi, please download the program on their official website.On the Raspberry Pi terminal, access PuTTY with the following command:</p><pre class="ql-syntax" spellcheck="false">$ putty
</pre><p>Alternatively, PuTTY can be run on the terminal of your PC Laptop; the radar sensor may simply be connected to your laptop first before connecting it again to the Raspberry Pi.</p><p><br></p><p><strong>Modify Persistent Settings for OPS243. </strong>Conveniently, the OPS243 Doppler Radar Sensor uses simple keyboard commands to read or write its current settings. All keyboard commands can be viewed from the official documentation from OmniPreSense <a href="https://omnipresense.com/wp-content/uploads/2019/10/AN-010-Q_API_Interface.pdf" rel="nofollow">here</a>.</p><p>The following keyboard commands are used:</p><p>For Both OPS243-C and -A</p><ol><li><strong>Oz</strong> (Disable Ignoring Watchdog Timer for USB Tx<li><strong>S1</strong> (Set Doppler Sampling Rate to 10k Hz)<li><strong>US</strong> (mph Speed Unit Setting)<li><strong>BV</strong> (Do not output blanks)<li><strong>R&gt;10</strong> (Reported Speed Minimum Filter Setting at 10 mph)<li><strong>OJ</strong> (Turn on JSON format)<li><strong>M&gt;150</strong> (Minimum Speed Magnitude at least 150)</ol><p>For OPS243-C Only:</p><ol><li><strong>r&gt;20</strong> (Reported Minimum Distance at 20 feet away)<li><strong>r&lt;60</strong> (Reported Maximum Distance at 60 feet away)<li><strong>OY </strong>(Combo Output)</ol><p>After these changes are made, you can view the current settings using the <strong>?? </strong>command. Save the current settings as persistent using the <strong>A!</strong> command. This means that these modified settings will remain after unplugging the sensor.</p>

## Step 7: Configure Raspberry Pi Camera Module
<p><strong>Fix Blurry Focus of Raspberry Pi Camera. </strong>Although the official Raspberry Pi website claims that their Camera Module has an auto focus, those who worked with their camera knows of how inherently blurry the $20-30 hardware can be. This can be easily fixed manually adjusting the focal lens of the camera module using a flat head screwdriver.</p><p>From <a href="https://www.jeffgeerling.com/blog/2017/fixing-blurry-focus-on-some-raspberry-pi-camera-v2-models" rel="nofollow">Jeff Geerling's blog post</a> on manually adjusting the focal lens, the following procedure was used for this particular project:</p><ol><li>With the flat head screwdriver, rotate the lens CW until there is a mechanical stop. This will be the reference angle for next step.<li>From the reference angle, rotate the lens <strong>CCW</strong> by <strong>0.875</strong> of 1 full rotation, which is 7/8th of a full rotation. In order to track the turn, pay close attention to one of the notches while turning the focal lens.</ol><p>With this manual focal lens adjustment, the Camera Module should be able to have refined images of objects approximately <strong>60 feet away</strong> or closer.</p>

## Step 8: 3D Camera Enclosure With Hex Nut Attachment
<p><strong>Option #1: 3D Printing</strong></p><ol><li><strong>Print the following STL files on 3D Printer with PLA Filament. </strong>See the attached STL files for the Top Enclosure and Bottom Enclosure. The print time is approximately 8 hours each, for a total of 16 hours. Intermediately long print jobs such as these necessitate for proper job preparation and calibration. Please review online resources for further information.<li><strong>Insert Hex Nut into 3D Printed Object.</strong> After successful print jobs, insert the 1/4&quot; 20 Hex Nut into the Bottom Enclosure print using a soldering iron to melt the nut into the object, or more conveniently, using a hot glue gun. This Instructable uses a hot glue gun, the more pragmatic but less rigid option. See the image above for results.</ol><p><strong>Alternative Option #2: Purchase Raspberry Pi Case Online. </strong>While having a 3D printed part customized for this project is ideal, not many individuals have access to a 3D printer. Therefore, <a href="https://ameridroid.com/products/smoothcam-raspberry-pi-4-camera-case-3d-printed" rel="nofollow">here</a> is an alternative Raspberry Pi Case that can be mounted to a Tripod Camera. For attaching the other hardware, please use fastening techniques such as duct tape or hot glue for effective rigidity.</p><p><strong>Insert Hardware Into Camera Enclosure.</strong></p><ol><li><strong>Connect Camera Module to Raspberry Pi. </strong>The strip camera module is inserted into the board of the Raspberry Pi like <a href="https://www.youtube.com/watch?v=VzYGDq0D1mw" rel="nofollow">so</a>. The camera itself is snapped into the top enclosure of the 3D printed object. {Insert Image}<li><strong>Wire 8x8 LED Matrix to Raspberry Pi.</strong> There are 5 pins that need to connected to the GPIO pins of the Raspberry Pi board: VCC, GND, DIN, CLK, and CS using the male-to-male Dupont wires. The image above taken from the <a href="https://max7219.readthedocs.io/en/0.2.3/" rel="nofollow">MAX7219 Python library</a> shows the Pin Assignments.<li><strong>Connect OPS243 Doppler Radar Sensor to Raspberry Pi (if not already). </strong>The radar sensor is connected to the board via USB cable. The radar sensor itself is snapped into the top enclosure of the 3D printed object. {Insert Image}.<li><strong>Connect Battery Pack to Power Supply of Raspberry Pi. </strong>Using the USB Female to USB-C cable, connect the battery pack to the power supply port of the Raspberry Pi. Though the Raspberry Pi 4 requires 3.5 A, the 2 A output from the battery pack was proven sufficient. It was found that the maximum power consumption of the traffic camera project is approximately <strong>1.3 A</strong>, so be aware of the battery size for the needs of your project. For example, using 20,000 mAh Li-Ion Battery Pack, it is expected that the traffic camera will last for approximately 13 hours before re-charge.<li><strong>(Optional) Wire Cooling Fan to Raspberry Pi. </strong>The cooling fan is wired to the 5V and GND GPIO pins of the Raspberry Pi board. Please see the attached image to view the pinout diagram of the Raspberry Pi. (Some cooling fans online come with fastening screws for direct placement on board, but any placement for effective cooling is fine for this project.)</ol><p><br></p><p><strong>Place Traffic Camera on Tripod. </strong>After all hardware is properly secured into enclosure of choice, attached the traffic camera onto the camera tripod via hex nut. (From previous experience, it is better to screw the tripod onto the camera rather than the camera onto the tripod.)</p><p><br></p><p><strong>** </strong>Note: If the hardware is not able to be snapped into the 3D printed object as expected, please use other fastening techniques like duct tape or hot glue as temporary solutions.**</p>

## Step 9: Test Python Project Indoors Before Outside
<p>Before taking the traffic camera to the road, it is safe to test for any immediate issues that may arise. Please review that all previous steps are performed correctly. Otherwise, one of the following issues will arise.</p><p><strong>Hardware Issues</strong></p><ul><li>No connection established between OPS243 and Raspberry Pi<li>Improper wiring of LED Matrix onto Raspberry Pi<li>Improper wiring of Cooling Fan onto Raspberry Pi<li>Improper attachment of Pi Camera onto  Raspberry Pi</ul><p><strong>Software Issues</strong></p><ul><li>Previous steps involving configuring Raspberry Pi<li>Previous step involving modifying <strong>main.py</strong> script<li>No Wi-Fi connection for LPR</ul>

## Step 10: Optimize Camera Mount Angle
<p><br></p><p><strong>Determine Mount Height. </strong>According to traffic laws, the maximum height for the placement of license plates is 5 feet. However, most license plates are no more than 2 feet from the ground. Low heights of <strong>1 to 2 feet</strong> of the tripod are effective mounting heights.</p><p><strong>Determine Mount Angle. </strong>Determining the mounting angle is a bit trickier. Referring to the diagram above, one can see that these parameters depends on the (1) how far the traffic camera is placed on the sidewalk, (2) how far the camera wants to begin detecting the speeding cars, (3) how many lanes the traffic camera wants to detect, and (4) the width of the individual traffic lanes. Assuming the standard width of each traffic lane as 12 feet, the traffic camera is placed __ feet from the sidewalk and placed at <strong>45 degree</strong> angle in order to effectively detect <strong>two traffic lanes </strong>at distances between ___ and ___ feet away.</p><p>It is important to note that the traffic camera angle for a <strong>single-lane configuration </strong>should place a <strong>30 degree angle. </strong>This should detect vehicles between ___ and ___ feet away.</p><p><br></p>
